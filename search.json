[{"title":"Hello World","url":"/2024/11/19/hello-world/","content":"<p>Welcome to <a href=\"https://hexo.io/\">Hexo</a>! This is your very first post. Check <a href=\"https://hexo.io/docs/\">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href=\"https://hexo.io/docs/troubleshooting.html\">troubleshooting</a> or you can ask me on <a href=\"https://github.com/hexojs/hexo/issues\">GitHub</a>.</p>\n<h2 id=\"Quick-Start\">Quick Start</h2>\n<h3 id=\"Create-a-new-post\">Create a new post</h3>\n<pre><code class=\"highlight bash\">$ hexo new <span class=\"string\">&quot;My New Post&quot;</span></code></pre>\n<p>More info: <a href=\"https://hexo.io/docs/writing.html\">Writing</a></p>\n<h3 id=\"Run-server\">Run server</h3>\n<pre><code class=\"highlight bash\">$ hexo server</code></pre>\n<p>More info: <a href=\"https://hexo.io/docs/server.html\">Server</a></p>\n<h3 id=\"Generate-static-files\">Generate static files</h3>\n<pre><code class=\"highlight bash\">$ hexo generate</code></pre>\n<p>More info: <a href=\"https://hexo.io/docs/generating.html\">Generating</a></p>\n<h3 id=\"Deploy-to-remote-sites\">Deploy to remote sites</h3>\n<pre><code class=\"highlight bash\">$ hexo deploy</code></pre>\n<p>More info: <a href=\"https://hexo.io/docs/one-command-deployment.html\">Deployment</a></p>\n"},{"title":"C# Web api使用Quartz進行一次性排程","url":"/2024/11/19/quartz/","content":"<h2 id=\"Install\">Install</h2>\n<pre><code class=\"highlight powershell\"><span class=\"built_in\">Install-Package</span> Quartz.AspNetCore\n<span class=\"built_in\">Install-Package</span> Quartz.Extensions.DependencyInjection\n<span class=\"built_in\">Install-Package</span> Quartz.Serialization.Json</code></pre>\n<h2 id=\"appsetting-json\">appsetting.json</h2>\n<p>這邊使用 Oracle 資料庫做為持久化儲存<a href=\"https://github.com/quartznet/quartznet/tree/main/database/tables\">各類資料庫腳本</a></p>\n<pre><code class=\"highlight json\"><span class=\"attr\">&quot;Quartz&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span>\n  <span class=\"attr\">&quot;quartz.scheduler.instanceName&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;QuartzOracleScheduler&quot;</span><span class=\"punctuation\">,</span>\n  <span class=\"attr\">&quot;quartz.scheduler.instanceId&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;AUTO&quot;</span><span class=\"punctuation\">,</span>\n  <span class=\"attr\">&quot;quartz.jobStore.type&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;Quartz.Impl.AdoJobStore.JobStoreTX, Quartz&quot;</span><span class=\"punctuation\">,</span>\n  <span class=\"attr\">&quot;quartz.jobStore.useProperties&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;true&quot;</span><span class=\"punctuation\">,</span>\n  <span class=\"attr\">&quot;quartz.jobStore.dataSource&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;default&quot;</span><span class=\"punctuation\">,</span>\n  <span class=\"attr\">&quot;quartz.jobStore.tablePrefix&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;QRTZ_&quot;</span><span class=\"punctuation\">,</span>\n  <span class=\"attr\">&quot;quartz.jobStore.driverDelegateType&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;Quartz.Impl.AdoJobStore.OracleDelegate, Quartz&quot;</span><span class=\"punctuation\">,</span>\n  <span class=\"attr\">&quot;quartz.dataSource.default.provider&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;OracleODPManaged&quot;</span><span class=\"punctuation\">,</span>\n  <span class=\"attr\">&quot;quartz.dataSource.default.connectionString&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;Your Connection String&quot;</span>\n<span class=\"punctuation\">&#125;</span></code></pre>\n<h2 id=\"Job-cs\">Job.cs</h2>\n<pre><code class=\"highlight C#\"> <span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">SendTasJob</span> : <span class=\"title\">IJob</span>\n &#123;\n     <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task <span class=\"title\">Execute</span>(<span class=\"params\">IJobExecutionContext context</span>)</span>\n     &#123;\n         <span class=\"comment\">//Job要實作的內容</span>\n          <span class=\"keyword\">var</span> tasid = context.MergedJobDataMap.GetString(<span class=\"string\">&quot;tasid&quot;</span>);\n          <span class=\"keyword\">var</span> welcomeText = context.MergedJobDataMap.GetString(<span class=\"string\">&quot;welcomeText&quot;</span>);\n          Console.WriteLine(tasid + welcomeText);\n          <span class=\"keyword\">return</span> Task.CompletedTask;\n     &#125;\n&#125;</code></pre>\n<h2 id=\"Controller-cs\">Controller.cs</h2>\n<pre><code class=\"highlight C#\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">TasController</span> : <span class=\"title\">ControllerBase</span>\n&#123;\n\n    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> ISchedulerFactory schedulerFactory;\n    <span class=\"keyword\">private</span> <span class=\"keyword\">readonly</span> IdGenerator idGenerator;\n\n    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">TasController</span>(<span class=\"params\">ISchedulerFactory schedulerFactory,</span></span>\n<span class=\"params\"><span class=\"function\">                         IdGenerator idGenerator</span>)</span>\n    &#123;\n        <span class=\"keyword\">this</span>.schedulerFactory = schedulerFactory;\n        <span class=\"keyword\">this</span>.idGenerator = idGenerator;\n    &#125;\n\n    [<span class=\"meta\">HttpPost(<span class=\"string\">&quot;[action]&quot;</span>)</span>]\n    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">async</span> Task&lt;IActionResult&gt; <span class=\"title\">ScheduleTasJob</span>(<span class=\"params\">TasJobRequest request</span>)</span>\n    &#123;\n        <span class=\"comment\">// 使用 SchedulerFactory 取得 Scheduler</span>\n        <span class=\"keyword\">var</span> sch = <span class=\"keyword\">await</span> schedulerFactory.GetScheduler();\n       <span class=\"comment\">// 雪花算法產Id</span>\n        <span class=\"keyword\">var</span> jobid = idGenerator.CreateId();\n        <span class=\"keyword\">var</span> jobKey = <span class=\"keyword\">new</span> JobKey(<span class=\"string\">$&quot;TasJob-<span class=\"subst\">&#123;jobid&#125;</span>&quot;</span>, <span class=\"string\">&quot;TasJobs&quot;</span>);\n        <span class=\"keyword\">var</span> triggerKey = <span class=\"keyword\">new</span> TriggerKey(<span class=\"string\">$&quot;TasJobTrigger-<span class=\"subst\">&#123;jobid&#125;</span>&quot;</span>, <span class=\"string\">&quot;TasJobs&quot;</span>);\n\n        <span class=\"comment\">// 建立Job</span>\n        <span class=\"keyword\">var</span> job = JobBuilder.Create&lt;SendTasJob&gt;()\n            .WithIdentity(jobKey)\n             <span class=\"comment\">//key value 如果有開啟UseProperties 只能有string型別</span>\n            .UsingJobData(<span class=\"string\">&quot;tasid&quot;</span>, request.TasId)\n            .UsingJobData(<span class=\"string\">&quot;welcomeText&quot;</span>, request.WelcomeText)\n            .StoreDurably() <span class=\"comment\">// 使任務持久化</span>\n            .Build();\n\n        <span class=\"comment\">// 設定Trigger</span>\n        ITrigger trigger = TriggerBuilder.Create()\n            .WithIdentity(triggerKey)\n            .StartAt(request.ExecuteAt ?? DateTime.UtcNow) <span class=\"comment\">// 指定執行時間</span>\n            .WithSimpleSchedule(x =&gt; x\n                .WithMisfireHandlingInstructionFireNow() <span class=\"comment\">// 當排程錯過執行時間時立即執行</span>\n                .WithRepeatCount(<span class=\"number\">0</span>) <span class=\"comment\">//只執行一次</span>\n                )\n            .Build();\n\n        <span class=\"keyword\">try</span>\n        &#123;\n           <span class=\"keyword\">await</span> sch.ScheduleJob(job, trigger);\n           Console.WriteLine(<span class=\"string\">$&quot;Scheduled job successfully with JobKey: <span class=\"subst\">&#123;jobKey.Name&#125;</span> and TriggerKey: <span class=\"subst\">&#123;triggerKey.Name&#125;</span>&quot;</span>);\n        &#125;\n        <span class=\"keyword\">catch</span> (Exception ex)\n        &#123;\n            Console.WriteLine(<span class=\"string\">$&quot;Failed to schedule job with JobKey: <span class=\"subst\">&#123;jobKey.Name&#125;</span> and TriggerKey: <span class=\"subst\">&#123;triggerKey.Name&#125;</span>&quot;</span>, ex);\n            <span class=\"keyword\">return</span> StatusCode(<span class=\"number\">500</span>, <span class=\"string\">&quot;Failed to schedule job&quot;</span>);\n        &#125;\n\n        <span class=\"keyword\">return</span> Ok(<span class=\"string\">$&quot;Scheduled job successfully with Job: <span class=\"subst\">&#123;jobKey.Name&#125;</span> and Trigger: <span class=\"subst\">&#123;triggerKey.Name&#125;</span>&quot;</span>);\n    &#125;\n&#125;</code></pre>\n<h2 id=\"Program-cs\">Program.cs</h2>\n<pre><code class=\"highlight C#\"><span class=\"comment\">// 從 appsettings.json 載入 Quartz 配置</span>\nbuilder.Services.Configure&lt;QuartzOptions&gt;(builder.Configuration.GetSection(<span class=\"string\">&quot;Quartz&quot;</span>));\n\n<span class=\"comment\">// 加入 Quartz 服務</span>\nbuilder.Services.AddQuartz(q =&gt;\n&#123;\n    q.UseJobFactory&lt;MicrosoftDependencyInjectionJobFactory&gt;();\n\n    <span class=\"comment\">// 持久化</span>\n    q.UsePersistentStore(opt =&gt;\n    &#123;\n        opt.UseProperties = <span class=\"literal\">false</span>;\n        opt.UseOracle(configuration =&gt;\n        &#123;\n            configuration.ConnectionString = builder.Configuration[<span class=\"string\">&quot;Quartz:quartz.dataSource.default.connectionString&quot;</span>];\n        &#125;);\n        opt.UseNewtonsoftJsonSerializer();\n    &#125;);\n&#125;);\nbuilder.Services.AddQuartzServer(q =&gt; q.WaitForJobsToComplete = <span class=\"literal\">true</span>); <span class=\"comment\">//hosting server</span>\n<span class=\"comment\">//builder.Services.AddQuartzHostedService(options =&gt;</span>\n<span class=\"comment\">//&#123;</span>\n<span class=\"comment\">//    // when shutting down we want jobs to complete gracefully</span>\n<span class=\"comment\">//    options.WaitForJobsToComplete = true;</span>\n<span class=\"comment\">//&#125;);</span>\nbuilder.Services.AddTransient&lt;SendTasJob&gt;(); <span class=\"comment\">// Job註冊</span>\n</code></pre>\n<h2 id=\"AddQuartzServer-vs-AddQuartzHostedService\">AddQuartzServer vs AddQuartzHostedService</h2>\n<p>AddQuartzServer 會多一個 Health Check 檢查 scheduler<br>\nSource Code 如下</p>\n<pre><code class=\"highlight C#\"><span class=\"keyword\">using</span> System;\n\n<span class=\"keyword\">using</span> Microsoft.Extensions.DependencyInjection;\n\n<span class=\"meta\">#<span class=\"keyword\">if</span> SUPPORTS_HEALTH_CHECKS</span>\n<span class=\"keyword\">using</span> Quartz.AspNetCore.HealthChecks;\n<span class=\"meta\">#<span class=\"keyword\">endif</span></span>\n\n<span class=\"keyword\">namespace</span> <span class=\"title\">Quartz</span>\n&#123;\n    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title\">QuartzServiceCollectionExtensions</span>\n    &#123;\n        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> IServiceCollection <span class=\"title\">AddQuartzServer</span>(<span class=\"params\"></span></span>\n<span class=\"params\"><span class=\"function\">            <span class=\"keyword\">this</span> IServiceCollection services,</span></span>\n<span class=\"params\"><span class=\"function\">            Action&lt;QuartzHostedServiceOptions&gt;? configure = <span class=\"literal\">null</span></span>)</span>\n        &#123;\n            <span class=\"meta\">#<span class=\"keyword\">if</span> SUPPORTS_HEALTH_CHECKS</span>\n            services\n                .AddHealthChecks()\n                .AddTypeActivatedCheck&lt;QuartzHealthCheck&gt;(<span class=\"string\">&quot;quartz-scheduler&quot;</span>);\n            <span class=\"meta\">#<span class=\"keyword\">endif</span></span>\n\n            <span class=\"keyword\">return</span> services.AddQuartzHostedService(configure);\n        &#125;\n    &#125;\n&#125;</code></pre>\n<h2 id=\"IIS-回收機制，排程失效\">IIS 回收機制，排程失效</h2>\n<ul>\n<li>關閉回收機制(程式應用集區 =&gt; 進階設定)<br>\n<img src=\"/images/InetMgr_ndjANFedAK.png\" alt=\"InetMgr_ndjANFedAK.png\"><br>\n<img src=\"/images/InetMgr_8EXFtPapjN.png\" alt=\"InetMgr_8EXFtPapjN.png\"></li>\n<li>定期呼叫 api 維持 server keep alive (ex.使用 window 排程)</li>\n</ul>\n<pre><code class=\"highlight powershell\"><span class=\"comment\"># File: InvokeApi.ps1</span>\n\n<span class=\"comment\"># 設定 URL</span>\n<span class=\"variable\">$url</span> = <span class=\"string\">&quot;your api url&quot;</span>\n<span class=\"comment\"># 設定 Log Path</span>\n<span class=\"variable\">$logFile</span> = <span class=\"string\">&quot;C:\\Scripts\\InvokeApi.log&quot;</span>\n\n<span class=\"comment\"># 調用 API</span>\n<span class=\"keyword\">try</span> &#123;\n    <span class=\"variable\">$response</span> = <span class=\"built_in\">Invoke-WebRequest</span> <span class=\"literal\">-Uri</span> <span class=\"variable\">$url</span> <span class=\"literal\">-Method</span> Get <span class=\"literal\">-TimeoutSec</span> <span class=\"number\">10</span>\n    <span class=\"variable\">$logEntry</span> = <span class=\"string\">&quot;<span class=\"variable\">$</span>(Get-Date) - API call successfully: <span class=\"variable\">$</span>(<span class=\"variable\">$response</span>.StatusCode)&quot;</span>\n&#125; <span class=\"keyword\">catch</span> &#123;\n    <span class=\"variable\">$logEntry</span> = <span class=\"string\">&quot;<span class=\"variable\">$</span>(Get-Date) - API call failed: <span class=\"variable\">$</span>(<span class=\"variable\">$_</span>.Exception.Message)&quot;</span>\n&#125;\n\n<span class=\"comment\"># 寫入日誌</span>\n<span class=\"variable\">$logEntry</span> | <span class=\"built_in\">Out-File</span> <span class=\"literal\">-FilePath</span> <span class=\"variable\">$logFile</span> <span class=\"literal\">-Append</span>\n</code></pre>\n<ul>\n<li>回收後，應用關閉事件添加應用重啟<br>\n<img src=\"/images/aplstart.png\" alt=\"aplstart.png\"></li>\n</ul>\n<h2 id=\"參考資料\">參考資料</h2>\n<p><a href=\"https://www.quartz-scheduler.net/\">https://www.quartz-scheduler.net/</a><br>\n<a href=\"https://stackoverflow.com/questions/75443765/quartz-aspnetcore-and-hosting-in-asp-net-core\">https://stackoverflow.com/questions/75443765/quartz-aspnetcore-and-hosting-in-asp-net-core</a><br>\n<a href=\"https://blog.csdn.net/qq_18932003/article/details/139672249\">https://blog.csdn.net/qq_18932003/article/details/139672249</a></p>\n","categories":["CSharp"],"tags":["CSharp","Quartz"]},{"title":"標籤","url":"/tags/index.html","content":""},{"title":"categories","url":"/categories/index.html","content":""}]